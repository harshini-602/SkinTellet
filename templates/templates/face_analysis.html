{% extends 'layout.html' %}

{% block content %}
<style>
    .predictions-container, .recommendations-container {
        background: #fff;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin-top: 20px;
        width: 80%;
        max-width: 600px;
        display:active;
    }

    .condition-title {
        color: #333;
        font-weight: bold;
        margin-top: 10px;
    }

    .product-list {
        list-style: none;
        padding: 0;
    }

    .product-list li {
        padding: 8px;
        border-bottom: 1px solid #eee;
        margin-bottom: 5px;
    }

    .product-list li:last-child {
        border-bottom: none;
    }
    .span{
        font-size:20px;
        font-weight: bold;
        font-family:serif;
    }

    #videoElement {
        width: 100%;
        height: auto;
        border: 2px solid #ccc;
        border-radius: 8px;
        display: none;
    }

    #canvas {
        display: none;
    }

    .camera-container {
        text-align: center;
        margin-top: 20px;
    }

    .button-container {
        display: flex;
        gap: 16px;
        justify-content: center;
        margin-bottom: 20px;
    }

    .action-button {
        padding: 8px 16px;
        font-size: 16px;
        font-weight: 600;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .primary-button {
        background-color: rgb(236 72 153);
        color: white;
    }

    .primary-button:hover {
        background-color: rgb(219 39 119);
    }

    .secondary-button {
        background-color: white;
        color: rgb(236 72 153);
        border: 2px solid rgb(236 72 153);
    }

    .secondary-button:hover {
        background-color: rgb(252 231 243);
    }
</style>

<div class="min-h-[90vh] w-screen flex items-center relative justify-center">
    <!-- Background Image -->
    <img src="../static/assets/bg.webp" alt="" class="absolute top-0 left-0 w-full h-full object-cover brightness-[90%] z-0">

    <div class="my-12 w-[50vw] bg-white bg-opacity-80 rounded-xl p-8 backdrop-blur-md z-10">
        <h1 class="text-[40px] leading-[45px] fon-bold">Upload or Capture Image</h1>
        <p class="text-zinc-500 mt-1">Get Expert AI evaluations of your skin.</p>
        <form action="/predict" method="post" enctype="multipart/form-data">
            <div class="my-6 w-full p-12 rounded-2xl border-pink-500 border-2 border-dashed flex flex-col gap-4 justify-center items-center">
                <!-- Button Container -->
                <div class="button-container">
                    <button type="button" onclick="handleFileClick()" class="action-button primary-button">Upload Image</button>
                    <button type="button" onclick="startWebcam()" class="action-button secondary-button">Use Webcam</button>
                </div>

                <!-- File Upload Option -->
                <input id="file" class="hidden" type="file" name="image" accept="image/*" required>
                <p class="mt-4 text-sm hidden" id="file-selected">File Selected!</p>

                <!-- Webcam Capture Option -->
                <div class="camera-container">
                    <video id="videoElement" autoplay></video>
                    <button type="button" id="captureButton" onclick="capturePhoto()" class="action-button primary-button mt-4 hidden">Capture Photo</button>
                    <canvas id="canvas"></canvas>
                </div>
            </div>

            <button class="px-6 py-2 text-white text-lg font-semibold bg-pink-500 hover:bg-pink-600 rounded-xl" type="submit">Predict</button>
        </form>

        <!-- Results Section -->
        <img src="" id="image" alt="" class="hidden mt-4 h-[400px] w-full object-fit">
        
        <div class="predictions-container">
            <h2 class="condition-title">Predictions:</h2>
            <ul id="prediction" class="product-list"></ul>
        </div>

        <div class="recommendations-container">
            <h2 class="condition-title">Recommendations:</h2>
            <ul id="recommendations" class="product-list"></ul>
        </div>
    </div>
</div>

<script>
    var data = '{{ data | tojson | safe }}';
    const jsonData = JSON.parse(data);
    console.log(jsonData);

    const fileInput = document.getElementById('file');
    const videoElement = document.getElementById('videoElement');
    const captureButton = document.getElementById('captureButton');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');

    function handleFileClick() {
        fileInput.click();
    }

    fileInput.addEventListener('change', () => {
        document.getElementById('file-selected').classList.toggle('hidden');
    });

    function startWebcam() {
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
            navigator.mediaDevices.getUserMedia({ video: true })
                .then(function(stream) {
                    videoElement.srcObject = stream;
                    videoElement.style.display = 'block';
                    captureButton.classList.remove('hidden');
                })
                .catch(function(err) {
                    console.log("Error accessing webcam: " + err);
                });
        } else {
            alert("Your browser does not support webcam access.");
        }
    }

    function capturePhoto() {
        if (videoElement.srcObject) {
            canvas.width = videoElement.videoWidth;
            canvas.height = videoElement.videoHeight;
            ctx.drawImage(videoElement, 0, 0, canvas.width, canvas.height);
            const dataURL = canvas.toDataURL('image/png');
            const imageBlob = dataURLtoBlob(dataURL);
            const file = new File([imageBlob], 'webcam_image.png', { type: 'image/png' });
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(file);
            fileInput.files = dataTransfer.files;
            document.getElementById('file-selected').classList.remove('hidden');
            
            // Stop the webcam and hide elements
            const stream = videoElement.srcObject;
            const tracks = stream.getTracks();
            tracks.forEach(track => track.stop());
            videoElement.style.display = 'none';
            captureButton.classList.add('hidden');
        } else {
            alert("Please start the webcam before capturing.");
        }
    }

    function dataURLtoBlob(dataURL) {
        const byteString = atob(dataURL.split(',')[1]);
        const arrayBuffer = new ArrayBuffer(byteString.length);
        const uintArray = new Uint8Array(arrayBuffer);
        for (let i = 0; i < byteString.length; i++) {
            uintArray[i] = byteString.charCodeAt(i);
        }
        return new Blob([arrayBuffer], { type: 'image/png' });
    }

    document.addEventListener("DOMContentLoaded", () => {
        if (jsonData.classes && jsonData.classes.length > 0) {
            const img = document.getElementById('image');
            if (img) {
                img.src = "/static/annotations_0.jpg";
                img.classList.remove('hidden');
            }
        }

        const predictionContainer = document.getElementById('prediction');
        jsonData.classes.forEach(condition => {
            const conditionItem = document.createElement('li');
            conditionItem.textContent = condition;
            predictionContainer.appendChild(conditionItem);
        });

        const recommendationContainer = document.getElementById('recommendations');
        jsonData.recommendations.forEach(item => {
            const condition = item[0];
            const products = item[1];
            const conditionItem = document.createElement('li');
        
            conditionItem.innerHTML = `<strong>${condition} :</strong> `;
            products.forEach(product => {
                const productItem = document.createElement('li');
                const Ingredients = product.Ingredients.replace(/[^a-zA-Z0-9\s]/g, "");
                productItem.innerHTML = `
                    <span>Brand :</span> ${product.Brand} <br>
                    <span>Name :</span>  ${product.Name} <br>
                    <span>Price :</span> $ ${product.Price} <br>
                    <span>Ingredients :</span> ${Ingredients}
                `;
                conditionItem.appendChild(productItem);
            });
            recommendationContainer.appendChild(conditionItem);
        });
    });
</script>

{% endblock %}